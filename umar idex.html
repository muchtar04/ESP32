<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ESP32 LoRa Irigasi - Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial, sans-serif;background:#f3f7fb;margin:0;padding:20px;color:#222}
    .card{background:white;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin:12px 0}
    .grid{display:flex;flex-wrap:wrap;gap:12px}
    .box{flex:1 1 180px;padding:12px;border-radius:10px;text-align:center}
    .big{font-size:1.6rem;font-weight:700}
    .controls{margin-top:10px}
    button{padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center}
    #login {max-width:360px;margin:40px auto}
    input{padding:10px;border-radius:8px;border:1px solid #ccc;width:100%;box-sizing:border-box;margin:8px 0}
  </style>
</head>
<body>
  <h1>ðŸŒ± Dashboard Irigasi (GitHub Pages)</h1>

  <div id="login" class="card">
    <h3>Login with Email</h3>
    <input id="email" placeholder="Email" type="email" />
    <input id="password" placeholder="Password" type="password" />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnCreate">Create Account</button>
    </div>
    <p id="loginStatus"></p>
  </div>

  <div id="app" style="display:none;">
    <div class="card">
      <div class="grid">
        <div class="box"><div>Temperature</div><div class="big" id="temp">-- Â°C</div></div>
        <div class="box"><div>Humidity</div><div class="big" id="hum">-- %</div></div>
        <div class="box"><div>Soil Avg</div><div class="big" id="soil">-- %</div></div>
        <div class="box"><div>Pompa</div><div class="big" id="pump">--</div></div>
      </div>
      <div class="controls">
        <button id="btnPumpToggle">Toggle Pump</button>
        <button id="btnModeToggle">Toggle Mode</button>
        <button id="btnLogout" style="float:right">Logout</button>
      </div>
    </div>

    <div class="card">
      <h3>Raw sensor</h3>
      <pre id="raw">no data</pre>
    </div>
  </div>

  <!-- Firebase JS SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>
    // ====== CONFIGURE HERE ======
    const firebaseConfig = {
      apiKey: "REPLACE_APIKEY",
      authDomain: "REPLACE_AUTHDOMAIN",
      databaseURL: "https://sitem-irigasi-tetes-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sitem-irigasi-tetes",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };
    // ============================

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const loginDiv = document.getElementById('login');
    const appDiv = document.getElementById('app');

    const tempEl = document.getElementById('temp');
    const humEl  = document.getElementById('hum');
    const soilEl = document.getElementById('soil');
    const pumpEl = document.getElementById('pump');
    const rawEl  = document.getElementById('raw');

    document.getElementById('btnLogin').onclick = async () => {
      const email = document.getElementById('email').value;
      const pass  = document.getElementById('password').value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        document.getElementById('loginStatus').innerText = 'Login berhasil';
      } catch (e) {
        document.getElementById('loginStatus').innerText = 'Login error: ' + e.message;
      }
    };

    document.getElementById('btnCreate').onclick = async () => {
      const email = document.getElementById('email').value;
      const pass  = document.getElementById('password').value;
      try {
        await auth.createUserWithEmailAndPassword(email, pass);
        document.getElementById('loginStatus').innerText = 'Akun dibuat, silakan login';
      } catch (e) {
        document.getElementById('loginStatus').innerText = 'Error: ' + e.message;
      }
    };

    document.getElementById('btnLogout').onclick = () => auth.signOut();

    // Realtime listener for data
    let sensorRef = db.ref('/SensorData');
    sensorRef.on('value', snap => {
      const v = snap.val() || {};
      tempEl.innerText = (v.temperature || '--') + ' Â°C';
      humEl.innerText  = (v.humidity || '--') + ' %';
      const s1 = parseFloat(v.soil1||0), s2 = parseFloat(v.soil2||0), s3 = parseFloat(v.soil3||0), s4 = parseFloat(v.soil4||0);
      const avg = (s1+s2+s3+s4)/ ( (s1||s2||s3||s4) ? 4:1 );
      soilEl.innerText = (isNaN(avg)?'--':avg.toFixed(0)) + ' %';
      pumpEl.innerText = (v.pump==1 || v.pump=='1' || (v.pump && (v.pump+"").toUpperCase()=="ON")) ? 'ON' : 'OFF';
      rawEl.innerText = JSON.stringify(v, null, 2);
    });

    // control buttons (write to Firebase)
    document.getElementById('btnPumpToggle').onclick = async () => {
      const snap = await sensorRef.child('pump').get();
      let current = snap.exists() ? snap.val() : 0;
      // toggle: if 'ON'/'1' -> set 0 else 1
      let newVal = (current==1 || (""+current).toUpperCase()=="ON") ? 0 : 1;
      await sensorRef.child('pump').set(newVal);
    };

    document.getElementById('btnModeToggle').onclick = async () => {
      const snap = await sensorRef.child('mode').get();
      let cur = snap.exists() ? snap.val() : 'AUTO';
      let next = (cur === 'AUTO') ? 'MANUAL' : 'AUTO';
      await sensorRef.child('mode').set(next);
    };

    // auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        loginDiv.style.display = 'none';
        appDiv.style.display = 'block';
      } else {
        loginDiv.style.display = 'block';
        appDiv.style.display = 'none';
      }
    });
  </script>
</body>
</html>
