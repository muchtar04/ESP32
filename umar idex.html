/***************************************************
 * ESP32 LoRa Receiver + Firebase + WebServer (Login Manual)
 * - Terima data DHT22 dari LoRa TX
 * - Tampilkan di Web Dashboard setelah login
 * - Simpan ke Firebase Realtime Database
 ***************************************************/

#include <WiFi.h>
#include <WebServer.h>
#include <SPI.h>
#include <LoRa.h>
#include <Firebase_ESP_Client.h>
#include <time.h>
#include <addons/TokenHelper.h>   // Sudah berisi tokenStatusCallback()
#include <addons/RTDBHelper.h>    // Untuk debug RTDB

// =================== KONFIGURASI ===================
#define WIFI_SSID       "jauh"
#define WIFI_PASSWORD   "hurufbesarsemua"

#define API_KEY         "AIzaSyDkbJKZodfTtqqyeU1E6jaSsi7qECSkk1U"
#define DATABASE_URL    "https://sitem-irigasi-tetes-default-rtdb.asia-southeast1.firebasedatabase.app/"
#define USER_EMAIL      "muchtarumar021@gmail.com"
#define USER_PASSWORD   "umar200321"

#define LORA_SS   5
#define LORA_RST  14
#define LORA_DIO0 26
#define LED_LORA  4
// ===================================================

// =================== LOGIN WEB ===================
const String login_username = "muchtar21";    // Ubah sesuai keinginan
const String login_password = "12345";    // Ubah sesuai keinginan
bool isLoggedIn = false;                  // Status login user

// Objek Web Server
WebServer server(80);

// Objek Firebase
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// Variabel global
String lastData = "T:-- H:--";
float suhu = 0.0;
float kelembapan = 0.0;

// Timer non-blok
unsigned long lastFirebaseUpdate = 0;
unsigned long lastBlink = 0;
bool ledState = false;

// =================================================== SETUP ===================================================
void setup() {
  Serial.begin(115200);
  pinMode(LED_LORA, OUTPUT);
  digitalWrite(LED_LORA, LOW);

  // === WiFi ===
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Menghubungkan ke WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(300);
  }
  Serial.println("\n‚úÖ WiFi tersambung!");
  Serial.print("Alamat IP: ");
  Serial.println(WiFi.localIP());

  // === LoRa ===
  SPI.begin(18, 19, 23, LORA_SS); // MOSI, MISO, SCK, SS
  LoRa.setPins(LORA_SS, LORA_RST, LORA_DIO0);
  if (!LoRa.begin(433E6)) {
    Serial.println("‚ùå Gagal inisialisasi LoRa!");
    while (1);
  }
  Serial.println("‚úÖ LoRa RX siap!");

  // === NTP (Waktu) ===
  configTime(7 * 3600, 0, "pool.ntp.org", "time.nist.gov");
  delay(2000);
  Serial.println("üïí Sinkronisasi waktu selesai");

  // === Firebase ===
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;
  config.token_status_callback = tokenStatusCallback; // dari TokenHelper.h

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  Serial.println("‚úÖ Firebase terhubung!");

  // === Web Server ===
  server.on("/", handleLoginPage);
  server.on("/login", HTTP_POST, handleLogin);
  server.on("/logout", handleLogout);
  server.on("/dashboard", handleDashboard);
  server.begin();
  Serial.println("üåê Web Server aktif di: http://" + WiFi.localIP().toString());
}

// =================================================== LOOP ===================================================
void loop() {
  server.handleClient();      // Jalankan Web Server
  bacaLoRa();                 // Cek paket LoRa
  updateFirebasePeriodik();   // Kirim data ke Firebase
  indikatorBlink(1000);       // LED heartbeat
}

// =================================================== BACA LORA ===================================================
void bacaLoRa() {
  int packetSize = LoRa.parsePacket();
  if (packetSize) {
    String incomingData = "";
    while (LoRa.available()) {
      incomingData += (char)LoRa.read();
    }
    lastData = incomingData;
    Serial.println("üì° Data diterima: " + incomingData);

    // Parsing format "T:28.4 H:70.2"
    int tIndex = incomingData.indexOf("T:");
    int hIndex = incomingData.indexOf("H:");
    if (tIndex != -1 && hIndex != -1) {
      suhu = incomingData.substring(tIndex + 2, hIndex).toFloat();
      kelembapan = incomingData.substring(hIndex + 2).toFloat();
    }

    // LED kedip singkat saat menerima data
    digitalWrite(LED_LORA, HIGH);
    delay(30);
    digitalWrite(LED_LORA, LOW);
  }
}

// =================================================== UPDATE FIREBASE ===================================================
void updateFirebasePeriodik() {
  if (Firebase.ready() && (millis() - lastFirebaseUpdate >= 10000)) {
    String basePath = "/SensorData";
    bool ok1 = Firebase.RTDB.setFloat(&fbdo, basePath + "/temperature", suhu);
    bool ok2 = Firebase.RTDB.setFloat(&fbdo, basePath + "/humidity", kelembapan);
    Firebase.RTDB.setString(&fbdo, basePath + "/timestamp", getTimeNow());

    if (ok1 && ok2)
      Serial.println("‚úÖ Data dikirim ke Firebase");
    else
      Serial.println("‚ùå Gagal kirim: " + fbdo.errorReason());

    lastFirebaseUpdate = millis();
  }
}

// =================================================== HALAMAN LOGIN ===================================================
void handleLoginPage() {
  if (isLoggedIn) {
    server.sendHeader("Location", "/dashboard");
    server.send(303);
    return;
  }

  String html = "<!DOCTYPE html><html lang='en'>"
                "<head>"
                "<meta charset='UTF-8'>"
                "<meta name='viewport' content='width=device-width, initial-scale=1'>"
                "<title>Login</title>"
                "<link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.2/css/all.css'>"
                "<style>"
                "body {font-family: Arial, sans-serif; background:#ecf0f1; margin:0; padding:0;}"
                ".login-box {width: 350px; margin: 100px auto; padding: 30px; background: #fff; border-radius: 12px; "
                "box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align:center;}"
                ".login-box h2 {margin-bottom: 25px; font-size: 1.5rem; color: #333;}"
                ".login-box h2 i {margin-right:10px; color:#3498db;}"
                "input[type=text], input[type=password] {width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; "
                "border-radius: 6px; font-size: 1rem;}"
                "button {background: #3498db; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; "
                "cursor: pointer; font-size: 1rem; transition:0.3s;}"
                "button:hover {background: #2980b9;}"
                "</style>"
                "</head>"
                "<body>"
                "<div class='login-box'>"
                "<h2><i class='fas fa-lock'></i>Login Dashboard</h2>"
                "<form method='POST' action='/login'>"
                "<input type='text' name='username' placeholder='Username' required><br>"
                "<input type='password' name='password' placeholder='Password' required><br>"
                "<button type='submit'>Login</button>"
                "</form>"
                "</div>"
                "</body></html>";
  server.send(200, "text/html", html);
}

void handleLogin() {
  if (server.hasArg("username") && server.hasArg("password")) {
    String user = server.arg("username");
    String pass = server.arg("password");
    if (user == login_username && pass == login_password) {
      isLoggedIn = true;
      server.sendHeader("Location", "/dashboard");
      server.send(303);
      return;
    }
  }
  server.send(200, "text/html", "<html><body><h3>‚ùå Login gagal. <a href='/'>Coba lagi</a></h3></body></html>");
}

void handleLogout() {
  isLoggedIn = false;
  server.sendHeader("Location", "/");
  server.send(303);
}

// =================================================== HALAMAN DASHBOARD ===================================================
void handleDashboard() {
  if (!isLoggedIn) {
    server.sendHeader("Location", "/");
    server.send(303);
    return;
  }

  String html = "<html>"
           "<head>"
           "<meta http-equiv='refresh' content='5'/>"
           "<meta name='viewport' content='width=device-width, initial-scale=1'>"
           "<link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.2/css/all.css'>"
           "<title>ESP32 Dashboard</title>"
           "<style>"
           "html { font-family: Arial; text-align: center; background: #f0f0f0; }"
           "h2 { font-size: 2.0rem; margin-top: 20px; }"
           ".box { display: inline-block; color: #fff; padding: 20px; margin: 15px;"
           "  border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); min-width: 200px; }"
           ".temp { background: #e74c3c; }"
           ".hum  { background: #3498db; }"
           "p { font-size: 1.5rem; margin: 10px 0; }"
           "i { font-size: 2rem; margin-right: 10px; }"
           "a{display:inline-block;margin-top:20px;text-decoration:none;padding:10px 20px;background:#333;color:white;border-radius:8px;}"
           "</style>"
           "</head>"
           "<body>"
           "<h2>ESP32 LoRa Receiver + Firebase</h2>"
           "<div class='box temp'>"
           "<p><i class='fas fa-thermometer-half'></i> Temperature</p>"
           "<p><b>" + String(suhu, 1) + " &deg;C</b></p>"
           "</div>"
           "<div class='box hum'>"
           "<p><i class='fas fa-tint'></i> Humidity</p>"
           "<p><b>" + String(kelembapan, 1) + " &percnt;</b></p>"
           "</div>"
           "<p>Data terakhir: " + lastData + "</p>"
           "<p><i class='fas fa-cloud-upload-alt'></i> Firebase: OK</p>"
           "<a href='/logout'>Logout</a>"
           "</body></html>";

  server.send(200, "text/html", html);
}

// =================================================== INDIKATOR LED ===================================================
void indikatorBlink(unsigned long interval) {
  if (millis() - lastBlink >= interval) {
    ledState = !ledState;
    digitalWrite(LED_LORA, ledState);
    lastBlink = millis();
  }
}

// =================================================== FUNGSI WAKTU ===================================================
String getTimeNow() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) return "Unknown";
  char buf[30];
  strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", &timeinfo);
  return String(buf);
}
